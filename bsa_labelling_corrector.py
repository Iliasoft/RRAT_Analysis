import os
import random
import sys
import numpy as np
import torch
import pandas as pd
import pickle
import random
import png
import scipy.ndimage
from tqdm import tqdm
import math

from bsa_data_prepare import MATRIX_LEN, MATRIX_WIDTH, EMBEDDINGS_FN, AUGMENTED_EMBEDDINGS_FN, AUGMENTED_EMBEDDINGS_MAP_FN, DATA_EXTRACT_FN, IMG_NAMES_KEY, LABELS_KEY, IMAGE_NAMES_KEY, LEGACY_PREDS_KEY, ID_KEY, TRUE_LABEL_KEY

LEGACY_PREDS_KEY = "pred_label"
if __name__ == '__main__':
    relabel_to_negative = (
        "H-240-000035",
        "H-388-000089",
        "H-390-000353",
        "L-109-000424",
        "L-331-000024",
        "L-331-000942",
        "L-331-001236",
        "L-331-001681",
        "L-340-000130",
        "L-340-000866"
    )

    relabel_to_positive = (
        "H-098-001207",
        "H-098-001427",
        "H-098-002045",
        "H-142-000125",
        "H-178-000124",
        "H-204-000113",
        "H-204-000135",
        "H-204-000149",
        "H-204-000291",
        "H-204-000308",
        "H-204-000322",
        "H-204-000329",
        "H-204-000350",
        "H-204-000352",
        "H-204-000353",
        "H-204-000366",
        "H-204-000384",
        "H-204-000393",
        "H-204-000408",
        "H-204-000409",
        "H-265-000136",
        "H-265-000311",
        "H-309-000164",
        "H-372-000026",
        "H-372-000300",
        "H-390-000000",
        "H-390-000001",
        "H-390-000002",
        "H-390-000003",
        "H-390-000004",
        "H-390-000016",
        "H-390-000019",
        "H-390-000020",
        "H-390-000028",
        "H-390-000033",
        "H-390-000044",
        "H-390-000050",
        "H-390-000051",
        "H-390-000062",
        "H-390-000065",
        "H-390-000066",
        "H-390-000067",
        "H-390-000069",
        "H-390-000076",
        "H-390-000077",
        "H-390-000080",
        "H-390-000085",
        "H-390-000087",
        "H-390-000089",
        "H-390-000092",
        "H-390-000096",
        "H-390-000102",
        "H-390-000106",
        "H-390-000107",
        "H-390-000108",
        "H-390-000109",
        "H-390-000110",
        "H-390-000114",
        "H-390-000116",
        "H-390-000117",
        "H-390-000118",
        "H-390-000121",
        "H-390-000123",
        "H-390-000124",
        "H-390-000125",
        "H-390-000127",
        "H-390-000128",
        "H-390-000129",
        "H-390-000131",
        "H-390-000135",
        "H-390-000137",
        "H-390-000138",
        "H-390-000139",
        "H-390-000142",
        "H-390-000143",
        "H-390-000144",
        "H-390-000146",
        "H-390-000148",
        "H-390-000150",
        "H-390-000151",
        "H-390-000152",
        "H-390-000153",
        "H-390-000154",
        "H-390-000157",
        "H-390-000159",
        "H-390-000164",
        "H-390-000165",
        "H-390-000167",
        "H-390-000169",
        "H-390-000170",
        "H-390-000173",
        "H-390-000174",
        "H-390-000176",
        "H-390-000177",
        "H-390-000179",
        "H-390-000182",
        "H-390-000184",
        "H-390-000189",
        "H-390-000192",
        "H-390-000193",
        "H-390-000194",
        "H-390-000199",
        "H-390-000201",
        "H-390-000203",
        "H-390-000204",
        "H-390-000207",
        "H-390-000212",
        "H-390-000216",
        "H-390-000218",
        "H-390-000219",
        "H-390-000223",
        "H-390-000227",
        "H-390-000230",
        "H-390-000237",
        "H-390-000241",
        "H-390-000242",
        "H-390-000263",
        "H-390-000264",
        "H-390-000278",
        "H-390-000280",
        "H-390-000284",
        "H-390-000287",
        "H-390-000289",
        "H-390-000291",
        "H-390-000292",
        "H-390-000297",
        "H-390-000298",
        "H-390-000303",
        "H-390-000305",
        "H-390-000310",
        "H-390-000317",
        "H-390-000319",
        "H-390-000324",
        "H-390-000335",
        "H-390-000337",
        "H-390-000338",
        "H-390-000341",
        "H-390-000350",
        "H-390-000359",
        "H-390-000361",
        "H-390-000362",
        "H-390-000364",
        "H-390-000370",
        "H-390-000371",
        "H-390-000373",
        "H-390-000374",
        "H-390-000376",
        "H-390-000377",
        "H-390-000382",
        "H-390-000383",
        "H-390-000384",
        "H-390-000387",
        "H-390-000391",
        "H-390-000395",
        "H-390-000398",
        "H-390-000400",
        "H-390-000402",
        "H-390-000404",
        "H-390-000405",
        "H-390-000408",
        "H-390-000409",
        "H-390-000410",
        "H-390-000412",
        "H-390-000414",
        "H-390-000416",
        "H-390-000417",
        "H-390-000424",
        "H-390-000426",
        "H-390-000427",
        "H-390-000434",
        "H-390-000440",
        "H-390-000441",
        "H-390-000442",
        "H-390-000444",
        "H-390-000445",
        "H-390-000446",
        "H-390-000448",
        "H-390-000454",
        "H-390-000456",
        "H-390-000457",
        "H-390-000459",
        "H-390-000465",
        "H-390-000466",
        "H-390-000475",
        "H-390-000476",
        "H-390-000486",
        "H-390-000488",
        "H-390-000494",
        "H-390-000495",
        "H-390-000503",
        "H-390-000508",
        "H-390-000518",
        "H-390-000521",
        "H-390-000522",
        "H-390-000523",
        "H-390-000530",
        "H-390-000531",
        "H-390-000534",
        "H-390-000553",
        "H-390-000561",
        "H-390-000573",
        "H-390-000574",
        "H-390-000596",
        "H-390-000602",
        "H-390-000614",
        "H-390-000618",
        "H-390-000620",
        "H-390-000623",
        "H-390-000624",
        "H-390-000625",
        "H-390-000627",
        "H-390-000629",
        "H-390-000630",
        "H-390-000632",
        "H-390-000633",
        "H-390-000638",
        "H-390-000651",
        "H-390-000652",
        "H-390-000656",
        "H-390-000657",
        "H-390-000661",
        "H-390-000674",
        "H-390-000675",
        "H-390-000676",
        "H-390-000679",
        "H-390-000684",
        "H-390-000685",
        "H-390-000687",
        "H-390-000694",
        "H-390-000697",
        "H-390-000703",
        "H-390-000709",
        "H-390-000710",
        "H-390-000711",
        "H-390-000717",
        "H-390-000722",
        "H-390-000725",
        "H-390-000730",
        "H-390-000731",
        "H-390-000737",
        "H-390-000738",
        "H-390-000740",
        "H-390-000746",
        "H-390-000748",
        "H-390-000757",
        "H-390-000762",
        "H-390-000763",
        "H-390-000764",
        "H-390-000765",
        "H-390-000770",
        "H-390-000773",
        "H-390-000779",
        "H-390-000781",
        "H-390-000786",
        "H-390-000788",
        "H-390-000789",
        "H-390-000803",
        "H-390-000821",
        "H-390-000828",
        "H-390-000829",
        "H-390-000830",
        "H-390-000831",
        "H-390-000832",
        "H-390-000835",
        "H-390-000839",
        "H-390-000842",
        "H-390-000843",
        "H-390-000845",
        "H-390-000849",
        "H-390-000852",
        "H-390-000853",
        "H-390-000856",
        "H-390-000859",
        "H-390-000860",
        "H-390-000862",
        "H-390-000865",
        "H-390-000868",
        "H-390-000871",
        "H-390-000874",
        "H-390-000875",
        "H-390-000877",
        "H-390-000880",
        "H-390-000883",
        "H-390-000893",
        "H-390-000897",
        "H-390-000905",
        "H-390-000937",
        "H-390-000958",
        "H-390-000964",
        "H-390-000989",
        "H-390-001005",
        "H-390-001010",
        "H-390-001017",
        "H-390-001033",
        "H-390-001037",
        "H-390-001057",
        "H-390-001061",
        "H-390-001065",
        "H-390-001067",
        "H-390-001069",
        "H-390-001072",
        "H-390-001073",
        "H-390-001075",
        "H-390-001077",
        "H-390-001079",
        "H-390-001084",
        "H-390-001087",
        "H-390-001091",
        "H-390-001097",
        "H-390-001098",
        "H-390-001099",
        "H-390-001100",
        "H-390-001101",
        "H-390-001103",
        "H-390-001104",
        "H-390-001106",
        "H-390-001107",
        "H-390-001109",
        "H-390-001115",
        "H-390-001116",
        "H-390-001117",
        "H-390-001118",
        "H-390-001120",
        "H-390-001121",
        "H-390-001130",
        "H-390-001131",
        "H-390-001132",
        "H-390-001136",
        "H-390-001140",
        "H-390-001143",
        "H-390-001157",
        "H-390-001159",
        "H-390-001162",
        "H-390-001164",
        "H-390-001166",
        "H-390-001168",
        "H-390-001169",
        "H-390-001174",
        "H-390-001175",
        "H-390-001176",
        "H-390-001178",
        "H-390-001180",
        "H-390-001182",
        "H-390-001187",
        "H-390-001190",
        "H-390-001199",
        "H-390-001201",
        "H-390-001205",
        "H-390-001206",
        "H-390-001207",
        "H-390-001213",
        "L-058-000139",
        "L-059-000048",
        "L-059-000050",
        "L-059-000215",
        "L-059-000220",
        "L-087-000008",
        "L-087-000017",
        "L-087-000032",
        "L-087-000045",
        "L-087-000064",
        "L-087-000071",
        "L-087-000078",
        "L-109-000097",
        "L-109-000158",
        "L-113-000156",
        "L-113-000196",
        "L-113-000208",
        "L-113-000248",
        "L-113-000259",
        "L-113-000277",
        "L-113-000307",
        "L-113-000338",
        "L-171-000018",
        "L-171-000052",
        "L-171-000062",
        "L-171-000073",
        "L-171-000111",
        "L-171-000237",
        "L-171-000241",
        "L-171-000261",
        "L-171-000271",
        "L-203-000385",
        "L-203-000471",
        "L-203-000945",
        "L-203-001019",
        "L-248-000030",
        "L-248-000073",
        "L-248-000081",
        "L-248-000107",
        "L-248-000126",
        "L-281-000353",
        "L-329-000250",
        "L-329-000254",
        "L-329-000489",
        "L-331-000267",
        "L-331-000420",
        "L-331-000445",
        "L-331-000462",
        "L-331-001159",
        "L-331-001391",
        "L-331-001610",
        "L-331-001635",
        "L-331-001662",
        "L-340-000043",
        "L-344-000973",
        "L-344-000990",
        "L-344-001005",
        "L-344-001042",
        "L-344-001090",
        "L-344-001100",
        "L-344-001102",
        "L-344-001116",
        "L-344-001278",
        "L-344-001567",
        "L-344-001988",
        "L-344-002018",
        "L-344-002251",
        "L-344-002316",
        "L-344-002432",
        "L-344-002478",
        "L-344-002604",
        "L-344-003548",
        "L-344-003557",
        "L-344-003574",
        "L-367-000129",
        "L-367-000132",
        "L-371-000009",
        "L-371-000075"
    )

    df = pd.read_csv(os.path.join(sys.argv[1], sys.argv[2]))
    ids = []
    true_labels = []
    old_preds = []
    for _, row in df.iterrows():
        if row[ID_KEY] in relabel_to_positive:
           row[TRUE_LABEL_KEY] = int(1)

        elif row[ID_KEY] in relabel_to_negative:
            row[TRUE_LABEL_KEY] = int(0)

        ids.append(row[ID_KEY])
        true_labels.append(row[TRUE_LABEL_KEY])
        old_preds.append(row[LEGACY_PREDS_KEY])

    df_corrected = pd.DataFrame(
        {
            ID_KEY: ids,
            LEGACY_PREDS_KEY:old_preds,
            TRUE_LABEL_KEY: true_labels,
        }
    )
    df_corrected[TRUE_LABEL_KEY] = df_corrected[TRUE_LABEL_KEY].astype('Int64')
    df_corrected.to_csv(
        os.path.join(sys.argv[1], sys.argv[3]), index=False
    )

